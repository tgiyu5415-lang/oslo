(function() {
    'use strict';
    console.log("QC SCRIPT LOADED");

    // ===== CONFIG =====
    const USERS = {
        "USER-001": "Aditia Rahman", "USER-002": "Ahmad Santoso", "USER-003": "Amar Maulana",
        "USER-004": "Ricka Yustira", "USER-005": "Dwi Prasetyo", "USER-006": "Mohammad Putra",
        "USER-007": "Tirangga Yala", "USER-008": "Tiya Alfianti", "USER-009": "Rima Alfiany",
        "USER-010": "Tonny Bagus Prakarsa", "USER-011": "Andrew Christofer Gieraldo"
    };

    function formatTime(sec) {
        let h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
        return [h, m, s].map(v => v.toString().padStart(2, "0")).join(":");
    }

    function init() {
        if (document.getElementById("qc-counter-pro")) return;
        console.log("INIT RUNNING");

        // --- 1. STATE VARIABLES ---
        let drag = false, dashDrag = false;
        let offsetX = 0, offsetY = 0, dashOffsetX = 0, dashOffsetY = 0;
        let count = parseInt(localStorage.getItem("qcCount")) || 0;
        let target = parseInt(localStorage.getItem("qcTarget")) || 50;
        let totalImages = parseInt(localStorage.getItem("qcTotalImages")) || 0;
        let sessionPageImages = 0;
        let failData = JSON.parse(localStorage.getItem("qcFailData") || "[]");
        let activeUserKey = localStorage.getItem("qcActiveLicense") || null;
        let posX = parseInt(localStorage.getItem("qcPosX")) || 20;
        let posY = parseInt(localStorage.getItem("qcPosY")) || 20;
        let minimized = localStorage.getItem("qcMin") === "true";
        let transparent = localStorage.getItem("qcTransparent") === "true";
        let stopwatchTime = parseInt(localStorage.getItem("qcStopwatch")) || 0;
        let stopwatchRunning = localStorage.getItem("qcRunning") === "true";

        // --- 2. CREATE UI BOX ---
        const box = document.createElement("div");
        box.id = "qc-counter-pro";
        box.style = `position:fixed; left:${posX}px; top:${posY}px; background:${transparent ? "rgba(20,20,20,0.7)" : "rgba(10,10,10,0.95)"}; backdropFilter:blur(14px); color:#f5d48f; padding:10px; border:1px solid rgba(255,218,134,0.4); borderRadius:14px; zIndex:9999; minWidth:220px; cursor:grab; userSelect:none;`;
        
        let userHTML = activeUserKey ? `<div>User: ${USERS[activeUserKey] || 'Unknown'}</div>` : "<div>Please Login</div>";
        
        box.innerHTML = `
            <div id="qc-header" style="font-weight:600; text-align:center; font-size:14px;">
                QC: <span id="qc-count">${count}</span> | IMG: <span id="qc-image-count">${totalImages}</span>
            </div>
            <div id="qc-body" style="display:${minimized ? 'none' : 'block'}; margin-top:10px;">
                Target: <input type="number" id="qc-target-input" value="${target}" style="width:40px; font-size:10px;"> 
                <button id="qc-set-target">Set</button>
                <div style="margin-top:8px; background:rgba(255,255,255,0.1); height:6px; border-radius:3px; overflow:hidden;">
                    <div id="qc-progress" style="height:100%; width:0%; background:lime;"></div>
                </div>
                <div style="margin-top:8px;">⏱ <span id="qc-stopwatch">00:00:00</span> <button id="qc-start-stop">Start</button></div>
                <div style="margin-top:8px; display:flex; gap:4px;">
                    <button id="qc-reset-images">Reset IMG</button>
                    <button id="qc-export-csv">CSV</button>
                </div>
            </div>
        `;
        document.body.appendChild(box);

        // --- 3. CREATE MINI DASHBOARD ---
        const dash = document.createElement("div");
        dash.id = "qc-mini-dashboard";
        dash.style = `position:fixed; top:80px; right:20px; zIndex:9999; background:#111; color:#0f0; padding:10px; borderRadius:10px; fontSize:12px; fontFamily:monospace; boxShadow:0 4px 12px rgba(0,0,0,0.5);`;
        document.body.appendChild(dash);

        // --- 4. INTERNAL FUNCTIONS ---
        function updateProgress() {
            let pct = Math.min((count / target) * 100, 100);
            const pEl = document.getElementById("qc-progress");
            if (pEl) pEl.style.width = pct + "%";
            document.getElementById("qc-count").textContent = count;
        }

        window.updateQCDashboard = function() {
            let sFail = JSON.parse(localStorage.getItem("qcStoredFailSkus") || "[]");
            let sPass = JSON.parse(localStorage.getItem("qcStoredPassSkus") || "[]");
            let currentFailSet = new Set();
            
            document.querySelectorAll(".qc-row").forEach(row => {
                const undoBtn = row.querySelector(".qc-row__undo-exception-button");
                if (undoBtn && window.getComputedStyle(undoBtn).display !== "none") {
                    currentFailSet.add(row.dataset.sku);
                }
            });

            const totalFailSet = new Set([...sFail, ...currentFailSet]);
            const byReason = {};
            failData.forEach(r => { 
                if (totalFailSet.has(r[2])) {
                    byReason[r[8]] = (byReason[r[8]] || 0) + 1;
                }
            });

            const topEntry = Object.entries(byReason).sort((a,b) => b[1] - a[1])[0];
            dash.innerHTML = `<b>📊 QC DASH</b><br>Fail: ${totalFailSet.size}<br>Top: ${topEntry ? topEntry[0] : '-'}`;
        };

        // --- 5. EVENT LISTENERS ---
        box.addEventListener("mousedown", e => {
            if (e.target.tagName !== "BUTTON" && e.target.tagName !== "INPUT") {
                drag = true; offsetX = e.clientX - box.offsetLeft; offsetY = e.clientY - box.offsetTop;
            }
        });

        document.addEventListener("mousemove", e => {
            if (drag) { box.style.left = (e.clientX - offsetX) + "px"; box.style.top = (e.clientY - offsetY) + "px"; }
        });

        document.addEventListener("mouseup", () => drag = false);

        document.getElementById("qc-start-stop").onclick = function() {
            stopwatchRunning = !stopwatchRunning;
            this.textContent = stopwatchRunning ? "Stop" : "Start";
            localStorage.setItem("qcRunning", stopwatchRunning);
        };

        // --- 6. INTERVALS ---
        setInterval(() => {
            if (stopwatchRunning) {
                stopwatchTime++;
                document.getElementById("qc-stopwatch").textContent = formatTime(stopwatchTime);
                localStorage.setItem("qcStopwatch", stopwatchTime);
            }
            // Scanner Workload
            let cards = document.querySelectorAll('.js-qc-row__image-card');
            sessionPageImages = cards ? cards.length : 0;
            document.getElementById("qc-image-count").textContent = totalImages + sessionPageImages;
            updateProgress();
        }, 1000);

        setInterval(window.updateQCDashboard, 2000);
        updateProgress();
    }

    if (document.readyState === 'loading') {
        window.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();