(function() {
    'use strict';
    console.log("QC SCRIPT LOADED");
    // ===== CONFIG =====
    const USERS = {
        "USER-001": "Aditia Rahman",
        "USER-002": "Ahmad Santoso",
        "USER-003": "Amar Maulana",
        "USER-004": "Ricka Yustira",
        "USER-005": "Dwi Prasetyo",
        "USER-006": "Mohammad Putra",
        "USER-007": "Tirangga Yala",
        "USER-008": "Tiya Alfianti",
        "USER-009": "Rima Alfiany",
        "USER-010": "Tonny Bagus Prakarsa",
        "USER-011": "Andrew Christofer Gieraldo"
    };
    const QC_RESET_HOUR = 23;
    const QC_RESET_MINUTE = 59;

    // ===== UTILS =====
    function formatTime(sec) {
        let h = Math.floor(sec / 3600);
        let m = Math.floor((sec % 3600) / 60);
        let s = sec % 60;
        return [h, m, s].map(function(v) {
            return v.toString().padStart(2, "0");
        }).join(":");
    }

    function downloadCSV(filename, rows) {
        const csvContent = "data:text/csv;charset=utf-8," + rows.map(function(r) {
            return r.map(function(c) {
                return `"${String(c === null || c === undefined ? "" : c).replace(/"/g,'""')}"`;
            }).join(",");
        }).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ===== INIT FUNCTION =====

    document.body.style.position = "relative";
    document.body.style.minHeight = "100vh";

    function init() {
        console.log("INIT RUNNING");

        function getSkuAttributes(row) {
            if (!row) return { color: "N/A", taxons: "N/A", auth: "N/A" };

            const attrElem = row.querySelector('.qc-row__sku-attributes');
            if (!attrElem) return { color: "N/A", taxons: "N/A", auth: "N/A" };

            // Ambil textContent agar lebih bersih dari spasi HTML
            const fullText = attrElem.textContent;

            const extractLabel = (text, label) => {
                // Regex diperketat: Ambil teks setelah label sampai bertemu karakter non-teks atau baris baru
                const regex = new RegExp(label + ":\\s*([^\\n\\r\\t]+)", "i");
                const match = text.match(regex);
                if (match) {
                    // Bersihkan spasi berlebih dan potong jika ada label label lain yang ikut terbawa
                    let result = match[1].trim();
                    return result.split("Condition:")[0].trim(); // Hard-cut untuk memastikan Condition tidak ikut
                }
                return "N/A";
            };

            return {
                color: extractLabel(fullText, "Colors"),
                taxons: attrElem.querySelector('.js-item-taxons')?.innerText?.replace(/\s+/g, ' ').trim() || "N/A",
                auth: extractLabel(fullText, "Auth Level")
            };
        }

        function snapToEdge(element, saveKeyX, saveKeyY) {
            const snapThreshold = 30;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            let finalX = element.offsetLeft;
            let finalY = element.offsetTop;

            if (finalX < snapThreshold) finalX = 0;
            else if (finalX > (windowWidth - element.offsetWidth - snapThreshold)) finalX = windowWidth - element.offsetWidth;

            if (finalY < snapThreshold) finalY = 0;
            else if (finalY > (windowHeight - element.offsetHeight - snapThreshold)) finalY = windowHeight - element.offsetHeight;

            element.style.transition = "all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            element.style.left = finalX + "px";
            element.style.top = finalY + "px";

            localStorage.setItem(saveKeyX, finalX + "px");
            localStorage.setItem(saveKeyY, finalY + "px");
            // Kembalikan ke transition normal setelah animasi selesai
            setTimeout(() => { element.style.transition = "all 0.25s ease"; }, 300);

        }

        document.addEventListener("mouseup", function(e) {
            // 1. Logika untuk Toolbar Utama
            if (drag) {
                drag = false;
                box.style.cursor = "grab";
                document.body.style.userSelect = "";

                // Snap to Edge untuk Toolbar Utama
                snapToEdge(box, "qcPosX", "qcPosY");
            }

            // 2. Logika untuk Dashboard Mini
            if (dashDrag) {
                dashDrag = false;
                dash.style.cursor = "grab";

                // Snap to Edge untuk Dashboard
                snapToEdge(dash, "dashPosX", "dashPosY");
            }
        });


        document.addEventListener("mousemove", function(e) {
            if (drag) {
                let x = e.clientX - offsetX;
                let y = e.clientY - offsetY;
                box.style.left = x + "px";
                box.style.top = y + "px";
            }

            if (dashDrag) {
                dash.style.left = (e.clientX - dashOffsetX) + "px";
                dash.style.top = (e.clientY - dashOffsetY) + "px";
                dash.style.right = "auto";
            }
        });

        // PEMICU UPDATE OTOMATIS SAAT INTERAKSI
        document.addEventListener("click", function(e) {
            const isSubmit = e.target.closest(".submit-button, .js-submit-button");
            const isFailAction = e.target.closest(".qc-row__fail-image-button, .qc-tool-detailed-image-modal__fail-image-button");
            const isUndoAction = e.target.closest(".qc-row__undo-exception-button");

            if (isSubmit || isFailAction || isUndoAction) {

                // LOGIKA KHUSUS UNDO: Hapus dari database sementara
                if (isUndoAction) {
                    const row = e.target.closest(".qc-row");
                    const sku = row ? row.dataset.sku : null;

                    if (sku) {
                        // 1. Hapus dari daftar Fail di LocalStorage
                        let storedFail = JSON.parse(localStorage.getItem("qcStoredFailSkus") || "[]");
                        storedFail = storedFail.filter(s => s !== sku);
                        localStorage.setItem("qcStoredFailSkus", JSON.stringify(storedFail));

                        // 2. Hapus dari failData (Memory & Storage) agar tidak muncul di CSV/Summary
                        failData = failData.filter(r => r[2] !== sku);
                        localStorage.setItem("qcFailData", JSON.stringify(failData));

                        // 3. Reset jejak tracking pada elemen gambar
                        row.querySelectorAll('[data-qc-tracked]').forEach(el => el.removeAttribute('data-qc-tracked'));
                    }
                }

                // Jalankan update dashboard setelah delay agar DOM selesai berubah
                setTimeout(() => {
                    if (typeof window.updateQCDashboard === "function") {
                        window.updateQCDashboard();
                    }
                }, 500);
            }
        });

        if (document.getElementById("qc-counter-pro")) return;

        // ===== STORAGE =====
        let count = parseInt(localStorage.getItem("qcCount")) || 0;
        let target = parseInt(localStorage.getItem("qcTarget")) || 50;
        let totalImages = parseInt(localStorage.getItem("qcTotalImages")) || 0;
        let sessionPageImages = 0;
        let countedRenders = JSON.parse(localStorage.getItem("qcCountedRenders") || "[]");
        let failData = JSON.parse(localStorage.getItem("qcFailData") || "[]");
        let passData = JSON.parse(localStorage.getItem("qcPassData") || "[]");
        let passCount = Number(localStorage.getItem("qcPassCount") || 0);

        let dashMinimized = false; // Dashboard State

        // ===== NEW SKU / IMAGE TRACKING =====
        let qcImageMap = JSON.parse(localStorage.getItem("qcImageMap") || "{}");
        let qcSkuProcessed = JSON.parse(localStorage.getItem("qcSkuProcessed") || "{}");

        // Menyimpan SKU terakhir yang berhasil dihitung gambarnya
        let lastProcessedSkus = JSON.parse(localStorage.getItem("qcLastProcessedSkus") || "[]");

        let posX = parseInt(localStorage.getItem("qcPosX")) || 20;
        let posY = parseInt(localStorage.getItem("qcPosY")) || 20;
        let minimized = localStorage.getItem("qcMin") === "true";
        let transparent = localStorage.getItem("qcTransparent") === "true";
        let stopwatchTime = parseInt(localStorage.getItem("qcStopwatch")) || 0;
        let stopwatchRunning = localStorage.getItem("qcRunning") === "true";
        let activeUserKey = localStorage.getItem("qcActiveLicense") || null;

        // ===== UI =====
        const box = document.createElement("div");
        box.id = "qc-counter-pro";
        box.style.position = "fixed";
        box.style.left = posX + "px";
        box.style.top = posY + "px";
        box.style.background = transparent ? "rgba(20,20,20,0.55)" : "rgba(10,10,10,0.95)";
        box.style.backdropFilter = "blur(14px)";
        box.style.webkitBackdropFilter = "blur(14px)";
        box.style.color = "#f5d48f";
        box.style.padding = "10px";
        box.style.fontSize = "10px";
        box.style.border = "1px solid rgba(255,218,134,0.4)";
        box.style.borderRadius = "14px";
        box.style.boxShadow = "0 10px 30px rgba(0,0,0,0.6)";
        box.style.zIndex = "9999";
        box.style.cursor = "grab";
        box.style.minWidth = "220px";
        box.style.transition = "all 0.25s ease";
        box.style.userSelect = "none";
        box.style.opacity = "0";
        box.style.transition = "opacity 0.4s ease, transform 0.25s ease, background 0.25s ease";

        // Hover glow
        box.addEventListener("mouseenter", function() {
            box.style.boxShadow = "0 0 25px rgba(245,212,143,0.45)";
            box.style.transform = "translateY(-2px)";
        });
        box.addEventListener("mouseleave", function() {
            box.style.boxShadow = "0 10px 30px rgba(0,0,0,0.6)";
            box.style.transform = "translateY(0)";
        });
        // ===== INNER HTML =====
        let userHTML = "";
        if (activeUserKey && USERS[activeUserKey]) {
            userHTML = `<div id="qc-user-active" style="margin-bottom:6px;font-weight:600;display:flex;align-items:center;gap:6px;">User: ${USERS[activeUserKey]} <button id="qc-logout" style="font-size:10px;padding:2px 6px;border-radius:5px;border:1px solid #ff4d4d;color:#ff4d4d;background:rgba(255,0,0,0.05);cursor:pointer;">Logout</button></div>`;
        } else {
            let options = "";
            Object.keys(USERS).forEach(function(k) {
                options += `<option value="${k}">${USERS[k]}</option>`;
            });
            userHTML = `<div id="qc-login-container" style="margin-bottom:6px;display:flex;gap:4px;"><select id="qc-user-select" style="font-size:10px;padding:2px 4px;">${options}</select><button id="qc-login" style="font-size:10px;padding:2px 6px;border-radius:5px;border:1px solid #ffda86;color:#ffda86;background:rgba(255,255,255,0.05);cursor:pointer;">Login</button></div>`;
        }

        box.innerHTML = `
<div id="qc-header" style="font-weight:600;margin-bottom:8px;text-align:center;font-size:14px;">
QC: <span id="qc-count" style="font-size:16px">${count}</span> |
IMG: <span id="qc-image-count" style="font-size:16px">${totalImages}</span>
</div>

${userHTML}

<div id="qc-body" style="transition:all 0.25s ease;">

Target:
<input type="number" id="qc-target-input" value="${target}" style="width:55px;font-size:10px">
<button id="qc-set-target">Set</button>

<div style="margin-top:6px;">
Progress:
<div style="background:rgba(255,255,255,0.08);height:6px;border-radius:6px;overflow:hidden;">
<div id="qc-progress" style="height:6px;width:0%;background:linear-gradient(90deg,#f5d48f,#ffb347);border-radius:6px;"></div>
</div>
</div>

<div style="margin-top:8px;">
⏱ <span id="qc-stopwatch">00:00:00</span>
<button id="qc-start-stop">Start</button>
<button id="qc-reset-time">Reset</button>
</div>

<div style="margin-top:8px;display:flex;align-items:center;gap:4px;">
    <button id="qc-dec" style="font-size:10px;">-</button>
    QC Count
    <button id="qc-inc" style="font-size:10px;">+</button>
    <input type="number" id="qc-manual" placeholder="Input" style="width:50px;font-size:10px">
    <button id="qc-set-manual">Set</button> <button id="qc-reset-count">Reset</button>
</div>

<div style="margin-top:8px;">
<button id="qc-reset-images">Reset IMG</button>
<button id="qc-toggle-transparency">Transparency</button>
<button id="qc-export-csv">Export CSV</button>
</div>

</div>
`;

        document.body.appendChild(box);

        requestAnimationFrame(() => {
            box.style.opacity = "1";
        });

        setTimeout(() => { box.style.opacity = "1"; }, 50);

        // ===== BUTTON STYLES =====
        box.querySelectorAll("button").forEach(btn => {
            btn.style.background = "rgba(255,255,255,0.05)";
            btn.style.border = "1px solid rgba(255,218,134,0.4)";
            btn.style.color = "#f5d48f";
            btn.style.borderRadius = "6px";
            btn.style.padding = "2px 6px";
            btn.style.cursor = "pointer";
            btn.style.transition = "all 0.2s ease";
            btn.onmouseenter = () => {
                btn.style.background = "rgba(255,255,255,0.15)";
                btn.style.boxShadow = "0 0 8px rgba(245,212,143,0.6)";
            }
            btn.onmouseleave = () => {
                btn.style.background = "rgba(255,255,255,0.05)";
                btn.style.boxShadow = "none";
            }
        });

        // ===== ELEMENTS =====
        const countEl = document.getElementById("qc-count");
        const countDisplay = document.getElementById("qc-count-display");
        const imageEl = document.getElementById("qc-image-count");
        const progressEl = document.getElementById("qc-progress");
        const stopwatchEl = document.getElementById("qc-stopwatch");
        const bodyEl = document.getElementById("qc-body");
        const userActiveEl = document.getElementById("qc-user-active") || document.getElementById("qc-login-container");
        const setManualBtn = document.getElementById("qc-set-manual");
        const manualInput = document.getElementById("qc-manual");
        if (setManualBtn) {
            setManualBtn.onclick = function(e) {
                e.stopPropagation();
                const newVal = parseInt(manualInput.value);
                if (!isNaN(newVal)) {
                    count = newVal;
                    localStorage.setItem("qcCount", count);
                    updateProgress(); // Memperbarui tampilan angka dan bar progress
                    manualInput.value = ""; // Bersihkan input setelah set
                } else {
                    alert("Please enter a valid number");
                }
            };
        }

        // ===== COLLAPSE/EXPAND VIA HEADER =====
        const headerEl = document.getElementById("qc-header");
        if (minimized) bodyEl.style.display = "none";

        headerEl.addEventListener("dblclick", (e) => {
            e.stopPropagation(); // Pastikan tidak merembet ke mana-mana
            if (bodyEl.style.display === "none") {
                bodyEl.style.display = "block";
                localStorage.setItem("qcMin", "false");
                countEl.style.fontSize = "16px";
                imageEl.style.fontSize = "16px";
            } else {
                bodyEl.style.display = "none";
                localStorage.setItem("qcMin", "true");
                countEl.style.fontSize = "13px";
                imageEl.style.fontSize = "13px";
            }
        });

        // ===== LOGIN / LOGOUT =====
        const loginBtn = document.getElementById("qc-login");
        if (loginBtn) {
            loginBtn.onclick = function(e) {
                e.stopPropagation();
                const sel = document.getElementById("qc-user-select");
                const val = sel.value;
                if (USERS[val]) {
                    localStorage.setItem("qcActiveLicense", val);
                    location.reload();
                }
            };
        }
        const logoutBtn = document.getElementById("qc-logout");
        if (logoutBtn) {
            logoutBtn.onclick = function(e) {
                e.stopPropagation();
                localStorage.removeItem("qcActiveLicense");
                location.reload();
            };
        }

        let celebrationActive = false;

        function launchConfettiAroundToolbar(toolbar) {

            if (celebrationActive) return;
            celebrationActive = true;

            const rect = toolbar.getBoundingClientRect();
            const colors = [
                "#f5d48f", "#ffb347", "#00ff88",
                "#00d4ff", "#ff4d4d", "#ffffff",
                "#ffd700", "#ff69b4"
            ];

            const container = document.createElement("div");
            container.style.position = "fixed";
            container.style.left = rect.left + "px";
            container.style.top = rect.top + "px";
            container.style.width = rect.width + "px";
            container.style.height = rect.height + "px";
            container.style.pointerEvents = "none";
            container.style.zIndex = "10000";
            document.body.appendChild(container);

            const particleCount = 100;

            for (let i = 0; i < particleCount; i++) {
                const piece = document.createElement("div");

                piece.style.position = "absolute";
                piece.style.width = Math.random() > 0.5 ? "6px" : "4px";
                piece.style.height = piece.style.width;
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.left = rect.width / 2 + "px";
                piece.style.top = rect.height / 2 + "px";
                piece.style.borderRadius = "2px";
                piece.style.opacity = "1";
                piece.style.transform = "translate(0,0) rotate(0deg)";
                piece.style.transition = "transform 1.4s cubic-bezier(.17,.67,.83,.67), opacity 1.4s ease-out";

                container.appendChild(piece);

                const angle = Math.random() * 2 * Math.PI;
                const radius = 80 + Math.random() * 120;
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;

                setTimeout(() => {
                    piece.style.transform = `translate(${x}px,${y}px) rotate(${Math.random()*720}deg)`;
                    piece.style.opacity = "0";
                }, 30);
            }

            setTimeout(() => {
                container.remove();
                celebrationActive = false;
            }, 1600);
        }

        function celebrationGlow(toolbar) {

            const glow = document.createElement("div");
            glow.style.position = "fixed";
            glow.style.left = toolbar.offsetLeft - 20 + "px";
            glow.style.top = toolbar.offsetTop - 20 + "px";
            glow.style.width = toolbar.offsetWidth + 40 + "px";
            glow.style.height = toolbar.offsetHeight + 40 + "px";
            glow.style.borderRadius = "20px";
            glow.style.background = "radial-gradient(circle, rgba(0,255,120,0.6) 0%, rgba(0,255,120,0.2) 40%, transparent 70%)";
            glow.style.pointerEvents = "none";
            glow.style.zIndex = "9998";
            glow.style.opacity = "0.9";
            glow.style.transition = "opacity 1.2s ease-out, transform 1.2s ease-out";
            document.body.appendChild(glow);

            setTimeout(() => {
                glow.style.opacity = "0";
                glow.style.transform = "scale(1.3)";
            }, 50);

            setTimeout(() => {
                glow.remove();
            }, 1300);
        }


        function playCelebrationSound() {
            try {
                const audioCtx = new(window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = "triangle";
                oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.3);

                gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } catch (e) {
                console.log("Audio blocked by browser policy");
            }
        }

        // ===== PROGRESS =====
        function updateProgress() {
            let pct = Math.min((count / target) * 100, 100);
            if (progressEl) {
                progressEl.style.width = pct + "%";
                progressEl.style.background = pct >= 100 ? "lime" : "linear-gradient(90deg,#f5d48f,#ffb347)";
            }
            if (countEl) countEl.textContent = count;
            if (countDisplay) countDisplay.textContent = count;

            // RUMUS SINKRON: Tampilkan total lama + halaman aktif
            if (imageEl) imageEl.textContent = totalImages + sessionPageImages;

            if (pct >= 100 && !celebrationActive) {

                box.animate(
                    [{
                        transform: "scale(1.18)"
                    }, {
                        transform: "scale(1)"
                    }], {
                        duration: 600,
                        iterations: 1,
                        easing: "ease-out"
                    }
                );

                box.style.background = "rgba(0,200,0,0.8)";

                launchConfettiAroundToolbar(box);
                celebrationGlow(box);
                playCelebrationSound();

                setTimeout(() => {
                    box.style.background = transparent ?
                        "rgba(20,20,20,0.55)" :
                    "rgba(10,10,10,0.95)";
                }, 1200);
            }
        }

        function makeKey(sku, imgId, imgSrc) {
            return `${sku}__${imgId || imgSrc}`.toLowerCase();
        }

        function time24() {
            const d = new Date();
            const pad = n => String(n).padStart(2, "0");
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        // ===== QC TRACKING (LOGIKA VALIDASI FAIL & UNDO) =====
        document.addEventListener("click", function(e) {
            const btn = e.target.closest("a.qc-row__fail-image-button, .qc-tool-detailed-image-modal__fail-image-button");
            if (!btn) return;

            const card = btn.closest(".js-qc-row__image-card") || btn;
            if (card.dataset.qcValidating === "true") return;
            card.dataset.qcValidating = "true";

            setTimeout(() => {
                // DEFINE SEMUA DI DALAM TIMEOUT AGAR ELEMENT SUDAH RENDER
                const modal = document.querySelector("#qc-tool-detailed-image-modal");
                const row = btn.closest(".qc-row");
                const reasonEl = document.querySelector(".js-selected-image__failed-reason, .selected-image__failed-reason");
                const undoBtn = row ? row.querySelector(".qc-row__undo-exception-button") : null;
                const modalUndo = modal ? modal.querySelector(".js-qc-tool-detailed-image-modal__undo-exception-button") : null;

                let reason = reasonEl ? reasonEl.innerText.trim() : "";
                let sku = "UNKNOWN";

                // PENCARIAN SKU YANG LEBIH KUAT
                if (modal) {
                    const skuEl = modal.querySelector(".qc-tool-detailed-image-modal__item-sku");
                    if (skuEl) sku = skuEl.innerText.trim();
                }
                // Jika masih UNKNOWN atau sedang di row
                if (sku === "UNKNOWN" && row) {
                    sku = row.dataset.sku || row.querySelector(".qc-row__sku-link")?.innerText.trim() || "UNKNOWN";
                }

                const isValidFail = reason && reason.toLowerCase() !== "no reason" && reason.toLowerCase() !== "none" && (undoBtn || modalUndo);

                if (!isValidFail) {
                    console.log("FAIL DIBATALKAN: Alasan masih kosong atau tombol Undo belum muncul.");
                    card.dataset.qcValidating = "false";
                    return;
                }

                card.dataset.qcTracked = "1";
                card.dataset.qcValidating = "false";

                const imgEl = card.querySelector("img");
                const imgSrc = imgEl ? imgEl.src.split("?")[0] : "UNKNOWN";
                const user = USERS[localStorage.getItem("qcActiveLicense")] || "Unknown User";
                const time = time24();

                // Ambil atribut menggunakan fungsi yang sudah diperbaiki di atas
                const attrs = getSkuAttributes(row || modal.closest(".qc-row"));

                const failRow = [time, user, sku, attrs.color, attrs.taxons, attrs.auth, imgSrc, "FAIL", reason];
                failData.push(failRow);
                localStorage.setItem("qcFailData", JSON.stringify(failData));

                if (typeof window.updateQCDashboard === "function") {
                    window.updateQCDashboard();
                }
            }, 1200);
        });

        // ===== SKU LEVEL SUBMIT LOGIC (VERSI FINAL TERBAIK) =====
        document.addEventListener("click", function(e) {
            const submitBtn = e.target.closest(".submit-button");
            if (!submitBtn) return;

            // A. Ambil data permanen (Dashboard Stats)
            let storedFail = JSON.parse(localStorage.getItem("qcStoredFailSkus") || "[]");
            let storedPass = JSON.parse(localStorage.getItem("qcStoredPassSkus") || "[]");
            let failSet = new Set(storedFail);
            let passSet = new Set(storedPass);

            // B. Kunci angka gambar halaman ini ke permanen
            totalImages += sessionPageImages; // <--- Pastikan ada operator +=
            sessionPageImages = 0; // Reset sesi halaman tersebut

            // C. Proses Scan SKU (Menentukan Pass/Fail & Ambil Link CSV)
            qcSkuProcessed = {};
            const rows = document.querySelectorAll(".qc-row");

            rows.forEach(row => {
                const sku = row.dataset.sku || row.querySelector("[data-sku]")?.dataset?.sku || "UNKNOWN";
                if (!sku || qcSkuProcessed[sku]) return;
                qcSkuProcessed[sku] = true;

                // Ambil atribut & cek status fisik di layar
                const attrs = getSkuAttributes(row);
                const hasUndo = row.querySelector(".qc-row__undo-exception-button");
                const hasReason = row.querySelector(".js-selected-image__failed-reason")?.innerText.trim();
                const isValidFail = hasUndo && hasReason && hasReason.toLowerCase() !== "no reason";

                // Cek apakah SKU ini sebelumnya sudah ditandai fail (dari klik gambar)
                const hasFailInMemory = failData.some(r => r[2] === sku && r[7] === "FAIL");

                const time = time24();
                const user = USERS[localStorage.getItem("qcActiveLicense")] || "Unknown User";

                if (isValidFail || hasFailInMemory) {
                    // LOGIKA FAIL
                    failSet.add(sku);
                    passSet.delete(sku);

                    if (!hasFailInMemory) {
                        // Tambahkan ringkasan fail jika belum tercatat
                        const failSummaryRow = [time, user, sku, attrs.color, attrs.taxons, attrs.auth, "", "FAIL", hasReason || "SKU Level Fail"];
                        failData.push(failSummaryRow);
                    }
                } else {
                    // LOGIKA PASS
                    if (!failSet.has(sku)) {
                        passSet.add(sku);
                    }

                    // SIMPAN DATA ASSETS UNTUK CSV (Penting!)
                    const imgCards = row.querySelectorAll('.js-qc-row__image-card');
                    if (imgCards.length > 0) {
                        imgCards.forEach(card => {
                            const img = card.querySelector('img');
                            const url = img ? img.src.split('?')[0] : "";
                            const passRow = [time, user, sku, attrs.color, attrs.taxons, attrs.auth, url, "PASS", ""];
                            if (typeof window.savePassRow === "function") window.savePassRow(passRow);
                        });
                    } else {
                        const passRow = [time, user, sku, attrs.color, attrs.taxons, attrs.auth, "", "PASS", ""];
                        if (typeof window.savePassRow === "function") window.savePassRow(passRow);
                    }
                }

                // Tambah Hitungan SKU Toolbar
                count++;
            });

            // D. SIMPAN PERMANEN KE LOCALSTORAGE (Hanya di sini!)
            localStorage.setItem("qcStoredFailSkus", JSON.stringify([...failSet]));
            localStorage.setItem("qcStoredPassSkus", JSON.stringify([...passSet]));
            localStorage.setItem("qcTotalImages", totalImages);
            localStorage.setItem("qcCount", count);
            localStorage.setItem("qcFailData", JSON.stringify(failData));

            // E. Sinkronisasi UI
            if (imageEl) imageEl.textContent = totalImages;
            updateProgress();
            if (typeof window.updateQCDashboard === "function") {
                window.updateQCDashboard();
            }
        });

        // ===== TARGET =====
        document.getElementById("qc-set-target").onclick = function(e) {
            e.stopPropagation();
            target = parseInt(document.getElementById("qc-target-input").value) || 1;
            localStorage.setItem("qcTarget", target);
            updateProgress();
        };

        // ===== QC INC/DEC =====
        document.getElementById("qc-inc").onclick = function(e) {
            e.stopPropagation();
            count++;
            localStorage.setItem("qcCount", count);
            updateProgress();
        };
        document.getElementById("qc-dec").onclick = function(e) {
            e.stopPropagation();
            count = Math.max(0, count - 1);
            localStorage.setItem("qcCount", count);
            updateProgress();
        };

        // ===== MANUAL COUNT =====
        document.getElementById("qc-manual").addEventListener("change", function(e) {
            let val = parseInt(this.value);
            if (!isNaN(val)) {
                count = val;
                localStorage.setItem("qcCount", count);
                updateProgress();
            }
        });

        // ===== RESET COUNT =====
        document.getElementById("qc-reset-count").onclick = function(e) {
            e.stopPropagation();
            count = 0;
            localStorage.setItem("qcCount", count);
            updateProgress();
        };

        // ===== STOPWATCH =====
        let timer;

        function updateStopwatch() {
            stopwatchEl.textContent = formatTime(stopwatchTime);
            localStorage.setItem("qcStopwatch", stopwatchTime);
        }
        if (stopwatchRunning) {
            timer = setInterval(() => {
                stopwatchTime++;
                updateStopwatch();
            }, 1000);
        }
        document.getElementById("qc-start-stop").onclick = function(e) {
            e.stopPropagation();
            if (stopwatchRunning) {
                clearInterval(timer);
                stopwatchRunning = false;
                localStorage.setItem("qcRunning", "false");
                this.textContent = "Start";
            } else {
                timer = setInterval(() => {
                    stopwatchTime++;
                    updateStopwatch();
                }, 1000);
                stopwatchRunning = true;
                localStorage.setItem("qcRunning", "true");
                this.textContent = "Stop";
            }
        };
        document.getElementById("qc-reset-time").onclick = function(e) {
            e.stopPropagation();
            stopwatchTime = 0;
            updateStopwatch();
        };
        updateStopwatch();

        // ===== TRANSPARENCY =====
        document.getElementById("qc-toggle-transparency").onclick = function(e) {
            e.stopPropagation();
            transparent = !transparent;
            box.style.background = transparent ? "rgba(20,20,20,0.55)" : "rgba(10,10,10,0.95)";
            localStorage.setItem("qcTransparent", transparent);
        };

        // ===== RESET IMAGE =====
        document.getElementById("qc-reset-images").onclick = function(e) {
            e.stopPropagation();
            totalImages = 0;
            lastProcessedSkus = []; // Kosongkan catatan SKU
            localStorage.setItem("qcTotalImages", 0);
            localStorage.setItem("qcLastProcessedSkus", JSON.stringify([]));
            imageEl.textContent = 0;
            alert("Image workload counter has been reset.");
        };

        // ===== CSV EXPORT =====
        document.getElementById("qc-export-csv").onclick = function(e) {
            e.stopPropagation();
            if (failData.length > 0 || passData.length > 0) {
                // Header baru yang lebih ringkas
                const header = [
                    ["Time", "User", "SKU", "Color", "Taxons", "Auth Level", "Image URL", "Status", "Reason"]
                ];

                const rows = header.concat(failData, passData).map(r =>
                                                                   r.map(v => (v === undefined || v === null ? "" : String(v)))
                                                                  );

                const d = new Date().toISOString().slice(0, 10);
                downloadCSV(`qc_report_${d}.csv`, rows);
            } else {
                alert("No QC Data Available");
            }
        };
        // ===== DRAG + SNAP =====
        let drag = false;
        let offsetX = 0, offsetY = 0;

        // Listener Mousedown untuk Toolbar Utama
        box.addEventListener("mousedown", function(e) {
            if (e.target.tagName === "BUTTON" || e.target.tagName === "INPUT") return;
            drag = true;
            box.style.cursor = "grabbing";
            offsetX = e.clientX - box.offsetLeft;
            offsetY = e.clientY - box.offsetTop;
            document.body.style.userSelect = "none";
            box.style.transition = "none"; // Matikan transisi saat ditarik
        });

        // ===== ENTERPRISE IMAGE WORKLOAD (SMART SYNC) =====
        function scanEnterpriseWorkload() {
            let cards = document.querySelectorAll('.js-qc-row__image-card');
            let currentRows = document.querySelectorAll('.qc-row');

            if (cards.length === 0 || currentRows.length === 0) {
                sessionPageImages = 0;
                if (imageEl) imageEl.textContent = totalImages;
                return;
            }

            // HITUNG GAMBAR DI LAYAR (Hanya simpan di variabel sesi)
            sessionPageImages = cards.length;

            // UPDATE TAMPILAN (Total Permanen + Sesi Sekarang)
            if (imageEl) {
                imageEl.textContent = totalImages + sessionPageImages;
            }
        }

        // Jalankan scanner secara berkala
        setTimeout(scanEnterpriseWorkload, 1500);
        setInterval(scanEnterpriseWorkload, 3000);


        // ===== QC SUMMARY PANEL =====
        const summaryBtn = document.createElement("button");
        summaryBtn.innerText = "📊 QC Summary";
        summaryBtn.style = `
    position: absolute;
    bottom: 20px;
    left: 20px;
    z-index: 99999;
    padding: 10px 14px;
    border-radius: 8px;
    background: #222;
    color: #fff;
    cursor: pointer;
`;

        document.body.appendChild(summaryBtn);

        summaryBtn.onclick = () => {
            let panel = document.getElementById("qc-summary-panel");

            if (panel) {
                panel.remove();
                return;
            }

            const failSkus = JSON.parse(localStorage.getItem("qcStoredFailSkus") || "[]");
            const passSkus = JSON.parse(localStorage.getItem("qcStoredPassSkus") || "[]");
            const totalFailSku = failSkus.length;
            const totalPassSku = passSkus.length;

            const byReason = {};
            const skuProcessedForReason = new Set();

            failData.forEach(r => {
                const sku = r[2];
                const reason = r[8] || "";
                const status = r[7] || "";
                if (status === "FAIL" && reason.toLowerCase() !== "no reason" && !skuProcessedForReason.has(sku)) {
                    byReason[reason] = (byReason[reason] || 0) + 1;
                    skuProcessedForReason.add(sku);
                }
            });

            const panelDiv = document.createElement("div");
            panelDiv.id = "qc-summary-panel";
            panelDiv.style = `
        position: fixed;
        bottom: 70px;
        left: 20px;
        z-index: 99999;
        background: #111;
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        font-size: 12px;
        width: 260px;
        max-height: 400px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 15px rgba(0,0,0,.5);
        border: 1px solid #333;
    `;

            panelDiv.innerHTML = `
        <div style="font-weight:bold; border-bottom:1px solid #444; padding-bottom:8px; margin-bottom:10px; flex-shrink: 0;">
            📋 QC SUMMARY REPORT
        </div>

        <div style="background:rgba(255,255,255,0.07); padding:10px; border-radius:6px; margin-bottom:12px; border:1px solid #444; flex-shrink: 0;">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <span>Total SKU Fail:</span>
                <b style="color:#ff6b6b">${totalFailSku}</b>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span>Total SKU Pass:</span>
                <b style="color:#4ade80">${totalPassSku}</b>
            </div>
        </div>

        <div style="font-size:11px; color:#aaa; margin-bottom:6px; text-transform:uppercase; flex-shrink: 0;">Failure Breakdown:</div>

        <div id="qc-reason-list" style="overflow-y: auto; flex-grow: 1; padding-right: 5px;">
            ${Object.entries(byReason).length > 0 ?
                Object.entries(byReason)
                .sort((a, b) => b[1] - a[1])
                .map(([reason, count]) => `
                    <div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #222;">
                        <span style="max-width:180px; word-wrap: break-word;">• ${reason}</span>
                        <b style="color:#ff9f43">${count}</b>
                    </div>
                `).join('')
            : `<div style="color:#666; font-style:italic;">No failures recorded.</div>`
        }
        </div>
    `;

            document.body.appendChild(panelDiv);
        };

        // ===== MINI QC DASHBOARD =====
        const dash = document.createElement("div");
        dash.id = "qc-mini-dashboard";
        dash.style = `
  position:fixed;
  top:80px;
  right:20px;
  z-index:99999;
  background:#111;
  color:#0f0;
  padding:10px 14px;
  border-radius:10px;
  font-size:12px;
  font-family:monospace;
  box-shadow:0 4px 12px rgba(0,0,0,.4);
`;
        dash.style.opacity = "0";
        dash.style.transition = "opacity 0.4s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";

        document.body.appendChild(dash);

        setTimeout(() => { dash.style.opacity = "1"; }, 50);

        // Load posisi Toolbar Utama
        if (localStorage.getItem("qcPosX")) {
            box.style.left = localStorage.getItem("qcPosX");
            box.style.top = localStorage.getItem("qcPosY");
        }

        // Load posisi Dashboard Mini
        if (localStorage.getItem("dashPosX")) {
            dash.style.left = localStorage.getItem("dashPosX");
            dash.style.top = localStorage.getItem("dashPosY");
            dash.style.right = "auto";
        }

        let dashDrag = false;
        let dashOffsetX = 0;
        let dashOffsetY = 0;
        let startX, startY;

        dash.addEventListener("mousedown", function(e) {
            if (e.target.tagName === "BUTTON") return;
            dashDrag = true;
            startX = e.clientX; // Catat posisi awal X
            startY = e.clientY; // Catat posisi awal Y
            dashOffsetX = e.clientX - dash.offsetLeft;
            dashOffsetY = e.clientY - dash.offsetTop;
            dash.style.transition = "none"; // Matikan transisi saat drag agar responsif
        });

        dash.addEventListener("dblclick", function(e) {
            // Jangan respon jika yang diklik adalah tombol Reset
            if (e.target.id === "qc-reset-all-dash") return;

            // Toggle status minimized
            let isMin = localStorage.getItem("qcDashMinimized") === "true";
            isMin = !isMin;

            // Simpan ke localStorage agar saat updateDashboard terpanggil, display-nya tetap sinkron
            localStorage.setItem("qcDashMinimized", isMin);

            // Langsung update UI tanpa menunggu interval 2 detik
            if (typeof window.updateQCDashboard === "function") {
                window.updateQCDashboard();
            }
        });

        // ===== UPDATE QC DASHBOARD =====
        window.updateQCDashboard = function() {
            if (dashDrag) return;
            const isMin = localStorage.getItem("qcDashMinimized") === "true";

            // 1. Ambil data PERMANEN yang sudah di-Submit sebelumnya
            let storedFail = JSON.parse(localStorage.getItem("qcStoredFailSkus") || "[]");
            let storedPass = JSON.parse(localStorage.getItem("qcStoredPassSkus") || "[]");

            // 2. Scan halaman saat ini (SESI AKTIF)
            const allRows = document.querySelectorAll(".qc-row");
            let currentFailSet = new Set();
            let currentPassSet = new Set();

            allRows.forEach(row => {
                const sku = row.dataset.sku;
                if (!sku) return;

                const hasTrackedFail = row.querySelector('.js-qc-row__image-card[data-qc-tracked="1"], .qc-image-overlay');
                const hasUndo = row.querySelector(".qc-row__undo-exception-button");
                const hasReasonText = row.querySelector(".js-selected-image__failed-reason")?.innerText.trim();
                const isValidReason = hasReasonText && hasReasonText.toLowerCase() !== "no reason";

                if (hasTrackedFail || (hasUndo && isValidReason)) {
                    currentFailSet.add(sku);
                } else {
                    // SKU ini Pass di halaman sekarang, tapi belum tentu sah (belum submit)
                    currentPassSet.add(sku);
                }
            });

            // 3. Hitung TOTAL untuk Tampilan: Permanen + Sesi Aktif
            // Gunakan Set untuk memastikan tidak ada duplikasi antara data lama dan data sekarang
            const totalFailSet = new Set([...storedFail, ...currentFailSet]);
            const totalPassSet = new Set([...storedPass]); // Hanya ambil yang sudah di-Submit (Permanen)

            // Untuk visual real-time agar user tetap bisa melihat progres di halaman aktif:
            currentPassSet.forEach(sku => {
                if (!totalFailSet.has(sku)) {
                    totalPassSet.add(sku); // Tambahkan hanya untuk tampilan layar
                }
            });

            const totalFailSku = totalFailSet.size;
            const totalPassSku = totalPassSet.size;

            // Statistik Reason (Tetap ambil dari memori failData)
            const byReason = {};
            const skuProcessedForReason = new Set();
            failData.forEach(r => {
                const sku = r[2];
                const reason = r[8] || "Unknown";
                if (totalFailSet && totalFailSet.has(sku) && !skuProcessedForReason.has(sku)) {
                    byReason[reason] = (byReason[reason] || 0) + 1;
                    skuProcessedForReason.add(sku);
                }
            });
            const topReason = Object.entries(byReason).sort((a, b) => b[1] - a[1])[0];

            // 4. Tampilkan di UI
            dash.innerHTML = `
        <div id="qc-dash-header" style="cursor:pointer;font-weight:600;">📊 QC DASHBOARD</div>
        <div id="qc-dash-body" style="margin-top:6px; display: ${isMin ? 'none' : 'block'};">
            Total SKU Fail: <b style="color:#ff6b6b">${totalFailSku}</b><br>
            Total SKU Pass: <b style="color:#4ade80">${totalPassSku}</b><br>
            Top Reason: ${topReason ? topReason[0]+" ("+topReason[1]+")" : "-"}
            <br><br>
            <button id="qc-reset-all-dash" style="background:rgba(255,80,80,.15); border:1px solid rgba(255,80,80,.4); color:#ff8080; padding:4px 8px; border-radius:6px; font-size:11px; cursor:pointer;">Reset Dashboard</button>
        </div>
    `;

            // Re-attach Reset Listener
            const resetBtn = document.getElementById("qc-reset-all-dash");
            if (resetBtn) {
                resetBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm("Reset Dashboard & Summary? (Toolbar tetap aman)")) {
                        localStorage.setItem("qcStoredFailSkus", "[]");
                        localStorage.setItem("qcStoredPassSkus", "[]");
                        failData = [];
                        localStorage.setItem("qcFailData", "[]");
                        window.updateQCDashboard();
                    }
                };
            }
        };

        // ===== SAVE PASS ROW =====
        window.savePassRow = function(row) {
            passData.push(row);
            localStorage.setItem("qcPassData", JSON.stringify(passData));
        };

        // ===== INCREMENT PASS COUNT =====
        window.incrementPassCount = function() {
            passCount++;
            localStorage.setItem("qcPassCount", passCount);
        };

        // ===== REFRESH DASHBOARD TIAP 2 DETIK =====
        setInterval(window.updateQCDashboard, 2000);
        window.updateQCDashboard();

        // ===== AUTO RESET DAILY =====
        function autoResetDaily() {
            const now = new Date();
            const resetTime = new Date();
            resetTime.setHours(23, 59, 0, 0);
            if (now > resetTime) resetTime.setDate(resetTime.getDate() + 1);
            const msUntilReset = resetTime - now;

            setTimeout(() => {
                localStorage.setItem("qcFailData", "[]");
                localStorage.setItem("qcPassData", "[]");
                localStorage.setItem("qcPassCount", "0");
                localStorage.setItem("qcImageMap", "{}");

                failData = [];
                passData = [];
                passCount = 0;
                qcImageMap = {};

                window.updateQCDashboard();

                const dashEl = document.getElementById("qc-mini-dashboard");
                if (dashEl) {
                    dashEl.innerHTML = `
<b>📊 QC DASHBOARD</b><br>
Total FAIL: <b style="color:#f55">0</b><br>
Total PASS: <b style="color:#5f5">0</b><br>
Top Reason: -<br>
<hr style="border:0;border-top:1px solid #333;margin:6px 0">
`;
                }

                alert("QC fail & pass data has been reset for the new day ✅");

                setInterval(() => {
                    localStorage.setItem("qcFailData", "[]");
                    localStorage.setItem("qcPassData", "[]");
                    localStorage.setItem("qcPassCount", "0");
                    localStorage.setItem("qcImageMap", "{}");
                }, 24 * 60 * 60 * 1000);
            }, msUntilReset);
        }

        if (!window.__qcAutoResetStarted) {
            window.__qcAutoResetStarted = true;
            autoResetDaily();
        }
    }
    // ===== RUN INIT =====
    window.addEventListener("load", function() {
        // Langsung jalankan init tanpa nunggu 1.5 detik
        // Gunakan interval kecil untuk cek apakah data web sudah siap
        // Jalankan secepat mungkin saat DOM siap
        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    });
})();